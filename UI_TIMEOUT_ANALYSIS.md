# UI 爬蟲超時機制 vs 進度任務系統 - 衝突分析

## 🔍 **發現的超時機制**

### 1. **HTTP 請求超時**
```python
# playwright_crawler_component_v2.py:688
with httpx.Client(timeout=600.0) as client:  # 10分鐘超時
```

### 2. **SSE 連接超時**
```python
# playwright_sse_handler.py:45
with requests.get(url, stream=True, timeout=600) as response:  # 10分鐘超時
```

### 3. **模擬進度停止**
```python
# playwright_crawler_component_v2.py:757
if elapsed > 300:  # 5分鐘後停止模擬
    break
```

### 4. **UI 刷新機制**
```python
# playwright_crawler_component_v2.py:482-484
if st.session_state.playwright_crawl_status == 'running':
    time.sleep(1)  # 每秒刷新
    st.rerun()
```

## ⚠️ **潛在衝突分析**

### 🔴 **嚴重衝突**

#### 1. **10分鐘超時 vs 後台任務**
- **問題**: UI 的 HTTP 請求 10分鐘超時，但後台任務可能需要更長時間
- **影響**: 大型任務（如爬取數百篇貼文）會被提前終止
- **現象**: 任務在 Redis 中標記為錯誤，但實際上還在後台運行

#### 2. **UI 狀態 vs 實際任務狀態**
- **問題**: UI 的 `session_state.playwright_crawl_status` 與 Redis 任務狀態不同步
- **影響**: UI 顯示任務完成，但 Redis 中任務仍在運行
- **現象**: 用戶無法正確監控真實任務狀態

### 🟡 **中等衝突**

#### 3. **進度模擬 vs 真實進度**
- **問題**: UI 的模擬進度 5分鐘後停止，但真實任務繼續
- **影響**: 用戶看到進度停止更新，以為任務卡死
- **現象**: 進度條不再動，但任務實際在後台正常進行

#### 4. **任務恢復機制**
- **問題**: UI 超時後無法正確恢復監控後台任務
- **影響**: 用戶需要手動到任務管理頁面查看
- **現象**: 任務完成後，UI 無法自動顯示結果

### 🟢 **輕微衝突**

#### 5. **刷新頻率差異**
- **問題**: UI 每秒刷新 vs 實際進度每8秒更新
- **影響**: 不必要的資源消耗
- **現象**: UI 響應稍慢

## 🛠️ **建議修復方案**

### **方案1: 延長 UI 超時時間** ⭐
```python
# 將10分鐘改為30分鐘或更長
with httpx.Client(timeout=1800.0) as client:  # 30分鐘
```

### **方案2: 實現真正的後台任務** ⭐⭐⭐
```python
def start_background_crawl():
    # 立即返回 task_id
    # 任務在後台 Docker 容器中運行
    # UI 只負責監控進度
```

### **方案3: 改善任務恢復** ⭐⭐
```python
def auto_recover_task():
    # 自動檢測超時的任務
    # 切換到監控模式
    # 從 Redis 讀取真實進度
```

### **方案4: 統一狀態管理** ⭐⭐
```python
def sync_ui_with_redis():
    # UI 狀態與 Redis 同步
    # 真實進度覆蓋模擬進度
```

## 🚨 **立即需要修復的問題**

### 1. **HTTP 超時過短**
大型爬取任務（>100篇貼文）經常超過10分鐘，導致：
- UI 顯示錯誤
- 用戶以為任務失敗
- 實際任務仍在後台運行

### 2. **狀態不同步**
UI 狀態與實際任務狀態脫鉤：
- `session_state` 顯示超時
- Redis 顯示任務仍在運行
- 用戶看到矛盾的狀態

### 3. **恢復機制缺失**
超時後無法自動恢復：
- 需要手動到任務管理頁面
- 無法在原頁面看到最終結果
- 用戶體驗差

## 🎯 **推薦修復順序**

1. **立即**: 延長 HTTP 超時到 30分鐘
2. **短期**: 實現超時後自動切換到監控模式  
3. **中期**: 統一 UI 狀態與 Redis 狀態
4. **長期**: 完全後台化任務執行

## 📊 **測試場景**

### 測試案例1: 大型任務
- 爬取 >100 篇貼文
- 預計耗時 >10 分鐘
- 驗證 UI 不會超時

### 測試案例2: 網路慢速
- 模擬慢速網路
- 驗證超時處理
- 確認任務可恢復

### 測試案例3: 瀏覽器關閉
- 任務進行中關閉瀏覽器
- 重新打開後恢復
- 驗證狀態一致性