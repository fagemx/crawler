ä»¥ä¸‹æ˜¯æ–°å•é¡Œ
æˆ‘è¦è™•ç†çˆ¬èŸ²æµç¨‹ 
æˆ‘è¦å…ˆå¾ä¸€ä½å¸³è™Ÿä¸»é é€²å…¥ 
ç„¶å¾ŒæŠ“100å‰‡ ä¾ç…§è§€çœ‹æ•¸æ’åº
Apify å¯ä»¥æ–¹ä¾¿æŠ“åˆ°ä¸»é å¤šå‰‡è²¼æ–‡çš„URL ä½†æ˜¯æ²’æœ‰ VIEWS

æ‰€ä»¥ç”¨ Apify Actor çˆ¬åˆ°URL ä¹‹å¾Œ
æˆ‘éœ€è¦å†URL å‰é¢åŠ ä¸Š https://r.jina.ai/
é€™æ¨£å¯ä»¥å¾—åˆ°jina è™•ç†éçš„æ ¼å¼
 jina å¯ä»¥æŠ“åˆ° views

ä½†æ˜¯ jina æœ‰views å»æ²’æœ‰è©³ç´°çš„

  "likes_count": "",
  "comments_count": "",
  "reposts_count": "",
  "shares_count": ""

åªæœ‰ç”¨æ•¸å­—è¡¨ç¤º  å¦‚æœå…¶ä¸­ä¸€å€‹æ˜¯0  æœƒç„¡æ³•å°é½Šæ¬„ä½
åªçŸ¥é“ç¼ºä¸€å€‹  å¦‚æœéƒ½æ»¿ å°±æ˜¯æ‰€éœ€è¦çš„

æ‰€ä»¥å¦‚æœç¼ºä¸€æ¬„  å°±è¦å…ˆæˆªåœ–  å†æŠŠè¢å¹•åœ–ç‰‡é€åˆ°gemini 2.5 flash å½±åƒè¾¨è­˜
æŠŠæ¬„ä½è£œé½Š

è£œé½Šä¹‹å¾Œ å°±æœ‰äº”å€‹æ•¸å€¼
  "views_count": "",
  "likes_count": "",
  "comments_count": "",
  "reposts_count": "",
  "shares_count": ""

æ¬Šé‡ä»¥ views_count æœ€é‡
likes_countèˆ‡comments_count å…¶æ¬¡
æ¥è‘—é–‹å§‹æŠŠ100å‰‡è²¼æ–‡æ’åº

ä»¥ä¸Šæµç¨‹ éœ€è¦å·¥ç¨‹åŒ– è€Œä¸”è¦é©ç”¨æ–¼A2Aæ¶æ§‹
é€™æ­¥é©Ÿå°±æ˜¯å…ˆæŠ“è²¼æ–‡ ç„¶å¾Œè¦æŠŠäº”å€‹æ¬„ä½å…ˆå¡«æ»¿
æ²’å¡«æ»¿çš„è¦ç”¨å½±åƒè¾¨è­˜å¡«æ»¿
ç„¶å¾Œæ’åº
æ¥è‘—æ‰ä¸‹ä¸€æ­¥ ä¾ç…§æ–‡å­—æˆ–æ˜¯åœ–ç‰‡é‚„æ˜¯å½±ç‰‡ ä¸‹ä¸€æ­¥é©Ÿ

è«‹å•é€™æ¨£è¦æ€éº¼è¦åŠƒ???

#####

#####
ğŸ’¬ è¨Šæ¯ï¼šèª¿ç”¨ Apify Actor: curious_coder/threads-scraper
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> Status: RUNNING, Message:
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> 2025-07-23T03:36:29.879Z ACTOR: Pulling Docker image of build JsuYrg5tPYSUHbnjv from registry.
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> 2025-07-23T03:36:29.880Z ACTOR: Creating Docker container.
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> 2025-07-23T03:36:30.005Z ACTOR: Starting Docker container.
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> 2025-07-23T03:36:33.420Z INFO  System info {"apifyVersion":"3.2.6","apifyClientVersion":"2.11.1","crawleeVersion":"3.12.1","osType":"Linux","nodeVersion":"v18.20.5"}
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> 2025-07-23T03:36:33.744Z INFO  BasicCrawler: Starting the crawler.
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> 2025-07-23T03:36:58.473Z WARN  BasicCrawler: Reclaiming failed request back to the list or queue. Request timeout after 20000ms
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> 2025-07-23T03:36:58.474Z     at file:///usr/src/app/src/client.js:195:19 {"id":"mxO5nXSKUM5jTl2","url":"https://www.threads.net/@09johan24","retryCount":1}
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> 2025-07-23T03:37:11.827Z INFO  BasicCrawler: All requests from the queue have been processed, the crawler will shut down.
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> 2025-07-23T03:37:11.924Z INFO  BasicCrawler: Final request statistics: {"requestsFinished":1,"requestsFailed":0,"retryHistogram":[null,1],"requestAvgFailedDurationMillis":null,"requestAvgFinishedDurationMillis":13349,"requestsFinishedPerMinute":2,"requestsFailedPerMinute":0,"requestTotalDurationMillis":13349,"requestsTotal":1,"crawlerRuntimeMillis":38103}
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> 2025-07-23T03:37:11.929Z INFO  BasicCrawler: Finished! Total 1 requests: 1 succeeded, 0 failed. {"terminal":true}
[apify.threads-scraper runId:2nGcih12JwIuukQtq] -> Status: SUCCEEDED, Message:
ğŸ“‹ ç‹€æ…‹ï¼šrunning - Apify Actor åŸ·è¡Œä¸­ï¼Œç­‰å¾…çµæœ...
ğŸ“ˆ é€²åº¦ï¼š20.0% - è™•ç†è²¼æ–‡ 1/5
ğŸ“ˆ é€²åº¦ï¼š40.0% - è™•ç†è²¼æ–‡ 2/5
ğŸ“ˆ é€²åº¦ï¼š60.0% - è™•ç†è²¼æ–‡ 3/5
ğŸ“ˆ é€²åº¦ï¼š80.0% - è™•ç†è²¼æ–‡ 4/5
ğŸ“ˆ é€²åº¦ï¼š100.0% - è™•ç†è²¼æ–‡ 5/5

âœ… æŠ“å–å®Œæˆï¼
ğŸ“Š ç¸½å…±æŠ“å–ï¼š5 å€‹ URL
â±ï¸  è™•ç†æ™‚é–“ï¼š51.81 ç§’
ğŸ‘¤ ç”¨æˆ¶ï¼š09johan24ğŸ” URL æ ¼å¼é©—è­‰ï¼š 
   é æœŸæ ¼å¼ï¼šhttps://www.threads.com/@username/post/code
   âœ… https://www.threads.com/@09johan24/post/C2RM1lbPWV2
   âœ… https://www.threads.com/@09johan24/post/DMaUaSnTRLQ
   âœ… https://www.threads.com/@09johan24/post/DMaQlaET9wO
   âœ… https://www.threads.com/@09johan24/post/DMaHMSqTdFs
   âœ… https://www.threads.com/@09johan24/post/DMZmCsHTA9U

âœ… æœ‰æ•ˆ URLï¼š5/5
####



####
LLM æˆªåœ– åˆ†æ

æå–ä¸»è¦è²¼æ–‡ä¸‹é¡¯ç¤ºçš„ä»¥ä¸‹æ•¸å­—ï¼Œåˆ†åˆ¥çš„æ•¸é‡æ˜¯å¤šå°‘?

viewsæ•¸é‡:
æ•¸é‡(æ„›å¿ƒ):  
ç•™è¨€(æ°£æ³¡):
è½‰ç™¼(æ—‹è½‰):
åˆ†äº«(ç´™é£›æ©Ÿ):
{
  "views_count": "",
  "likes_count": "",
  "comments_count": "",
  "reposts_count": "",
  "shares_count": ""
}
#####

# pip install screenshotone

from screenshotone import Client, TakeOptions

# create API client
client = Client("lE6SdLD9Vftg0Q", "ZYX53aD4rYjHqw")

# set up options
options = TakeOptions.url("https://www.threads.com/@earthmomltpodcast/post/DMa5BCWy27Z").format("jpg")
    .block_ads(true)
    .block_cookie_banners(true)
    .block_banners_by_heuristics(false)
    .block_trackers(true)
    .delay(0)
    .timeout(60)
    .response_type("by_format")
    .image_quality(80)

# generate URL
url = client.generate_take_url(options)
print(url)
# expected output: https://api.screenshotone.com/take?url=...

# or download the screenshot
image = client.take(options)

# store the screenshot in a file
with open("path_to_file.ext", "wb") as f:
    f.write(image)
# the screenshot is stored in the provided file path

###################

### æŠŠéœ€æ±‚æ‹†æˆ **4 å€‹æ˜ç¢ºæ­¥é©Ÿ + 3 æ”¯å¯ç¨ç«‹éƒ¨ç½²çš„ Agent**

ï¼ˆæ¯æ”¯ Agent éƒ½ç¬¦åˆ A2Aï¼š`POST /a2a/message`ï¼Œä¸¦é™„ä¸€å¼µ AgentCard è¨»å†Šåˆ° MCPï¼‰

```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      threads-scraper Actor
UI â”€â”€â–¶ ORCâ”‚CrawlerAgentâ”‚â”€â”€â”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      (JSON  ç„¡ views)     â”‚
                           â–¼                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Step 2                      Step 1
          â”‚JinaAgent   â”‚â”€â”€r.jina.ai/URLâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (views ä½†ç¼º 4 æ¬„)

                 â”‚  è‹¥ still missing æ¬„ä½
                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Step 3 (fallback)
          â”‚VisionAgent â”‚â”€â”€ScreenshotOneâ†’Gemini-Flash
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (è£œ likes/comments/â€¦ )

                 â”‚ å…¨ 5 æ¬„å°±ç·’
                 â–¼
          Step 4 â”€â”€> ORC åšæ’åº â†’ å¾ŒçºŒåˆ†æ/ç”Ÿæˆ
```

---

## 1. ä»‹é¢å¥‘ç´„ï¼ˆå…±ç”¨ Pydantic Modelï¼‰

```python
class Metrics(BaseModel):
    url: str
    views: int | None = None
    likes: int | None = None
    comments: int | None = None
    reposts: int | None = None
    shares: int | None = None
```

æ‰€æœ‰ Agent éƒ½ **æ”¶/å›** `List[Metrics]`ï¼Œæœªå–åˆ°çš„æ¬„ä½ä¿æŒ `None`ã€‚

---

## 2. ä¸‰æ”¯ Agent çš„æ ¸å¿ƒé‚è¼¯

### 2-1 CrawlerAgent  (Apify)

```python
async def run(username: str, limit: int = 100) -> list[Metrics]:
    run = await apify.actor("threads-scraper").call(
        {"username": username, "max_posts": limit}
    )
    ds = apify.dataset(run["defaultDatasetId"])
    posts = []
    async for item in ds.iterate_items():
        posts.append(Metrics(url=item["url"]))          # åªå…ˆå­˜ URL
    return posts
```

### 2-2 JinaAgent  (views è§£æ)

```python
async def run(batch: list[Metrics]) -> list[Metrics]:
    out = []
    async with httpx.AsyncClient() as cli:
        for m in batch:
            r = await cli.get(f"https://r.jina.ai/http://{m.url.lstrip('https://')}")
            data = json.loads(r.text)["meta"]
            m.views = int(data.get("views", 0))
            # å…¶é¤˜å››æ¬„ä¸ä¸€å®šå­˜åœ¨ â†’ ä¿æŒ None
            out.append(m)
    return out
```

### 2-3 VisionAgent  (ScreenshotOne + Gemini-Flash)

```python
SCREEN_API = Client(os.getenv("SHOT_KEY"), os.getenv("SHOT_SECRET"))
GEMINI     = genai.GenerativeModel("gemini-2.0-flash")

SS_PROMPT = """
æå–è¢å¹•æˆªåœ–ä¸­è²¼æ–‡ä¸»è¦çµ±è¨ˆæ•¸å­—ï¼š
viewsã€æ„›å¿ƒã€ç•™è¨€ã€è½‰ç™¼ã€åˆ†äº«ï¼ˆè‹¥ä¸å­˜åœ¨è¼¸å‡º 0ï¼‰ï¼›
åƒ…å›å‚³ JSON: {"views":x,"likes":x,"comments":x,"reposts":x,"shares":x}
"""

async def run(partials: list[Metrics]) -> list[Metrics]:
    out = []
    for m in partials:
        if all([m.views, m.likes, m.comments, m.reposts, m.shares]):
            out.append(m); continue            # å·²å®Œæ•´
        # 1. Screenshot
        take_url = SCREEN_API.generate_take_url(
            TakeOptions.url(m.url).format("jpg").response_type("by_format")
        )
        img_bytes = httpx.get(take_url).content
        # 2. Gemini Vision
        res = GEMINI.generate_content(
            [genai.ImagePart(img_bytes, mime_type="image/jpeg"),
             genai.TextPart(SS_PROMPT)]
        )
        d = json.loads(res.text)
        m.likes    = m.likes    or d["likes"]
        m.comments = m.comments or d["comments"]
        m.reposts  = m.reposts  or d["reposts"]
        m.shares   = m.shares   or d["shares"]
        out.append(m)
    return out
```

---

## 3. Orchestrator Workflowï¼ˆç°¡åŒ–ç‰ˆï¼‰

```python
async def collect_and_sort(username: str):
    posts = await call_agent("crawler",  {"username": username})
    posts = await call_agent("jina",     {"posts": posts})
    posts = await call_agent("vision",   {"posts": posts})

    # æ¬Šé‡è¨ˆç®—
    def score(m: Metrics):
        return (m.views or 0)*1.0 + (m.likes or 0)*0.3 + (m.comments or 0)*0.3
    posts.sort(key=score, reverse=True)
    return posts[:100]    # å·²å®Œæ•´ä¸¦æŒ‰æ¬Šé‡æ’åº
```

> **call\_agent**ï¼A2A clientï¼šå‚³é€² `{"role":"user","parts":[{"kind":"data","data":...}]}`ï¼Œä¸²æµæ¥æ”¶é€²åº¦ã€‚

---

## 4. AgentCard ç¯„ä¾‹ï¼ˆVisionAgentï¼‰

```json
{
  "name": "Vision Metrics Filler",
  "url": "http://vision-agent:8003/",
  "version": "0.1.0",
  "capabilities": { "streaming": true },
  "skills": [{
    "id": "fill_metrics",
    "description": "è£œé½Šè²¼æ–‡äº’å‹•æ•¸ï¼ˆlikes/comments/...ï¼‰",
    "input_schema": {
      "type":"array",
      "items": { "$ref": "#/definitions/Metrics" }
    }
  }]
}
```

---

## 5. ä½‡åˆ— / ä½µç™¼ ç­–ç•¥

* **CrawlerAgent**ï¼šä¸€æ¬¡æŠŠ 100 URL æ”¾é€² `asyncio.gather`ï¼ŒApify ä»åªç®— 1 CUã€‚
* **VisionAgent**ï¼šScreenshot & Gemini è²´ â†’ `Semaphore(5)` æ§åˆ¶ä½µç™¼ï¼Œä¸¦å°‡å¤±æ•— URL é‡è©¦ â‰¤ 2 æ¬¡ã€‚
* è‹¥æ—¥å¾Œè¦æ°´å¹³æ“´å¼µï¼Œå†æŠŠ three Agents æ¥ NATS Queueï¼›MVP å¯ç›´æ¥ `asyncio`.

---

## 6. å¾ŒçºŒæ­¥é©Ÿ

1. **å¯¦æ¸¬** 5 æ¢ URLï¼Œç¢ºä¿ Gemini prompt èƒ½å¯é æŠ“äº”æ¬„ã€‚
2. åŠ å…¥ **å–®å…ƒæ¸¬è©¦**ï¼š

   * `test_jina_parse_views()`
   * `test_vision_fill_missing(metrics_with_hole)`
3. Orchestrator æ’åºå¾ŒæŠŠ list å­˜ SQLiteï¼›æ¥ä¸‹ä¾†çš„ã€Œæ–‡æœ¬ vs åœ–ç‰‡/å½±ç‰‡ã€åˆ¤æ–·å³å¯æ ¹æ“š `media_urls` åšåˆ†æµã€‚

é€™æ¨£æ•´æ¢ã€ŒæŠ“å– â†’ è£œé½Šäº”æ¬„ â†’ æ’åºã€åœ¨ A2A å…§æ‹†å‡ºä¸‰å€‹è·è²¬æ˜ç¢ºçš„ Agentï¼Œ**ä¸å¿…ä¸€æ¬¡å¼•å…¥ Redis/NATS** å°±èƒ½å…ˆè·‘é€šï¼›ç•¶è²¼æ–‡é‡æˆ–åŒæ™‚ç”¨æˆ¶è®Šå¤šï¼Œå†æŠŠ VisionAgent æ‹†å¤šå‰¯æœ¬æ›ä½‡åˆ—å³å¯ã€‚
