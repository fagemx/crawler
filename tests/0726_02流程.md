### 🗂️ 多領域通用 A‑B‑C‑D 四層寫作系統：三階段 LLM Pipeline

> **A 層 — 創新熵層**
> **B 層 — 去模仿層（五大淡化技巧）**
> **C 層 — 帳號節奏層（任何帳號都可先行萃取）**
> **D 層 — 骨架＋肌肉層（論述邏輯＋感官私語）**

---

## 👁‍🗨 Pipeline 總覽

```
STEP 0  │輸入原貼文 5‑10 篇
────────┼─────────────────────────────────────
STEP 1  │分析階段  (Prompt‑1) ➜ 產出「分析 JSON」
────────┼─────────────────────────────────────
STEP 2  │生成階段  (Prompt‑2) ➜ 動態組裝規則 → 生成貼文
────────┼─────────────────────────────────────
STEP 3* │檢查／優化 (Prompt‑3, optional) ➜ 相似度‧抄襲率‧熵指標
```

\*STEP 3 可配置「循環 N 次直到指標達標」或僅做一次報告。

---

## 0️⃣ 輸入說明（5‑10 篇原貼文）

* 保留換行、emoji、標點。
* 可來自任何領域帳號（美食、理財、旅遊、靈性…）。
* 前置去除 URL、@標籤，以減少噪音。

---

## 1️⃣ 分析階段 Prompt‑1

### System (固定寫法，可程式注入)

> ```
> 你是「社群貼文風格分析器」。  
> 下面列出可用四層規則摘要：  
> ------------------------------------------------------------  
> [A層 ‑ 創新熵]  
>   A1 語意分散 ‑ 降重複；A2 特徵跳躍 ‑ 情緒突變 …  
> [B層 ‑ 去模仿]  
>   B1 情緒曲線重塑；B2 語義色票；B3 隱喻轉寫；B4 結構拼圖；B5 韻律映射  
> [C層 ‑ 帳號節奏]  
>   C1 短句引子；C2 長句推演；C3 口語停頓；C4 感官具體；C5 弱連貫；C6 溫柔收束  
> [D層 ‑ 骨架肌肉]  
>   D1 骨架：邏輯/句式；D2 肌肉：私語/感官  
> ------------------------------------------------------------  
> 解析時請引用代號，不必逐句展開規則全文。  
> ```

### User (自動拼接原文)

> ```
> 【任務】
> 1. 閱讀 <DOC_1> … <DOC_8>（共 8 篇）。
> 2. 判斷此帳號風格最需採用哪些 A/B/C/D 子規則（可多選）。
> 3. 依「0=不用 ~ 3=強烈」打分，並產出 JSON：  
> {
>   "A": {"A1":0‑3, ...},
>   "B": {"B1":0‑3, ...},
>   "C": {"C1":0‑3, ...},
>   "D": {"D1":0‑3, "D2":0‑3},
>   "note": "120字內說明判斷依據"
> }  
> 4. 只輸出 JSON。  
> ```

---

## 2️⃣ 生成階段 Prompt‑2

### 2‑A 後端邏輯（伺服器或腳本）

```python
rules_library = load_rule_snippets()   # 各子規則對應文字指令
analysis = json_result                 # 來自 Prompt‑1

selected_snippets = []
for layer, subrules in analysis.items():
    for code, score in subrules.items():
        if score >= 1:
            snippet = rules_library[code]
            snippet = scale_strength(snippet, score)  # 依 1‑3 調輕重
            selected_snippets.append(snippet)

final_system_prompt = BASE_SYSTEM + "\n".join(selected_snippets)
```

### 2‑B 最終 System Prompt 組合（例）

> ```
> 你是「社群貼文創作者」。  
> ‑ 使用 C1 2~6 字短句起頭/轉折；C3 加入口語停頓；  
> ‑ 長句依 C2，在 12‑22 字；  
> ‑ 套用 B2，將高頻詞替換為同色票詞；  
> ‑ 注入 D1 邏輯骨架＋D2 感官私語；  
> ‑ 少量使用 A4 非標準語序 (<=2 次)。  
> ```

### 2‑C User Prompt (任務)

> ```
> 主題：{用戶輸入}  
> 目標長度：8‑12 行，2‑4 emoji  
> 請依系統規則生成。  
> ```

LLM 輸出即為【貼文草稿】。

---

## 3️⃣ 可選：檢查/優化階段 Prompt‑3

### System

> ```
> 你是「貼文品質審核員」。  
> 請比較 <原文集合> 與 <草稿>，回傳：  
> 1. 風格相似度 0‑100  
> 2. 抄襲率 (% 同句或高度相似片語)  
> 3. 熵評分 (用詞多樣度 0‑100)  
> 4. 建議：<=80字  
> 只輸出 JSON。  
> ```

### 自動優化邏輯

* **若抄襲率 > 25%** → 強化 A1、B4；回到 STEP 2 重新生成。
* **若相似度 < 60%** → 強化 C1\~C3；回到 STEP 2。
* **若熵 < 40** → 提升 A2/A4。
* 最多迴圈 3 次；取最佳草稿。

---

## 📑 通用化關鍵

1. **規則庫模組化**：A/B/C/D 子規則各自獨立 snippet，任何領域帳號先由分析階段打分選擇。
2. **領域‑無關**：C層不侷限「靈性」，而是「帳號專屬節奏」。若分析結果顯示 C1‑C4 分數低，可僅採 A/B/D。
3. **可疊代**：Step 3 依需求開關；不嚴格可跳過。
4. **易擴充**：新風格 → 新 C 層子規則；新淡化技巧 → 加入 B 層編碼；無須改整體框架。

---

### 💻 附：rules\_library 簡化範例

```python
rules_library = {
  "A1": "- 在段落中嘗試使用少見形容詞及冷門比喻，避免重複字詞。",
  "A4": "- 允許 1‑2 句倒裝或非標準語序，如「雨，今晚靜得奇怪」。",
  "B2": "- 將『快樂/開心』替換為『盈亮/發光』等同色詞。",
  "C1": "- 以 2~6 字短句開場或轉折，並換行。",
  "C2": "- 用 12~22 字長句推演，可用「可以/可能/帶來」。",
  "D2": "- 插入感官詞，如『杯緣的水蒸氣』『手心微熱』。",
  ...
}
```

---

## 🎯 總結

* **分析階段**：告知 LLM 規則總覽 → 回收「多層打分 JSON」。
* **生成階段**：程式化把高分子規則轉為 System Prompt + 主題。
* **檢查階段 (可選)**：量化相似度 / 抄襲率 / 熵 → 自動微調或報告。

此三階段架構既**通用**又**可擴充**，能快速接入任何台灣社群帳號貼文，並自動產出高質量新內容。

############

## 1. 什麼是 *System + User Prompt*？

在 Chat‑/Completion API 裡，你一次請求就會送 **多個 role**：

| role   | 用途                                  |
| ------ | ----------------------------------- |
| system | 給模型的「最高指令」。定義身份、風格、嚴格規則。<br>使用者看不到。 |
| user   | 真正的「工作內容」。通常是主題、問題、要生成的長度⋯⋯         |

在 **雙階段流程** 裡，我們**調用 LLM 兩次**：

1. **分析階段**

   * `system`: 放「A B C D 規則總表 + 分析任務說明」
   * `user`: 放 5‑10 篇原貼文
     ➜ 回傳 *分析 JSON*
2. **生成階段**

   * `system`: 由你的後端組裝「高分子規則 snippet」＋固定寫作守則
   * `user`: 只有「主題 / 長度 / emoji 數量」等外顯要求
     ➜ 回傳貼文草稿

---

## 2. 如何把分析藏在後端，客戶只看到生成？

### 🔧 建議架構（微服務或單 API 皆可）

```
Client (客戶前端)
        │
        │  POST /generate   ← 客戶只打這支
        ▼
Backend Gateway ──────────► 1) Internal /analyze (LLM call #1)
                            2) 傳回分析 JSON
                            3) build_system_prompt(分析JSON)
                            4) Internal /write  (LLM call #2)
                            5) 回傳 final text
        ▲
        │
        └──  最終貼文
```

### 步驟拆解

| 步驟                        | 作用                                        | 對客戶可見？ |
| ------------------------- | ----------------------------------------- | ------ |
| ① `/analyze`              | 隱藏 endpoint；呼叫 LLM，送出 System+User (含規則總覽) | ❌      |
| ② 儲存 *分析 JSON*            | 例如：`{"A":{"A1":1…},"B":…}`                | ❌      |
| ③ `build_system_prompt()` | 讀 template 庫 → 插入「高分子規則」                  | ❌      |
| ④ `/write`                | 呼叫 LLM 第二次，生成文字                           | ❌      |
| ⑤ 回傳貼文                    | 只含貼文本身＋基本 metadata                        | ✅      |

客戶完全不知道第一階段指令內容，也看不到規則細節。

---

## 3. prompt 內容放哪裡？三種做法

| 做法               | 優點                  | 注意              |
| ---------------- | ------------------- | --------------- |
| **硬寫程式碼**        | 快速、純後端，安全           | 修改需重佈署          |
| **環境變數 / 祕鑰管控**  | DevOps 常用，CI/CD 好維護 | 字數限制，需加密        |
| **遠端 URL/DB 拉取** | 熱更新，不用重佈署           | 請以後端伺服器存取，勿前端直連 |

> **最佳實務**：<br>把各子規則（A1…D2）存 JSON 或 Markdown 模板檔 ➜ 部署在私有 S3 / Git 私倉 ➜ 後端啟動時載入到 `rules_library` 變數。客戶端永遠拿不到原始模板。

---

## 4. 範例程式片段（Python pseudo‑code）

```python
def generate_post(topic, raw_posts):
    # 1) 分析
    analysis_json = llm_chat(
        system=open("prompts/analyze_system.md").read(),
        user=f"<<原文合集>>\n{raw_posts}"
    )

    # 2) 動態拼 System Prompt
    sys_prompt = build_system_prompt(analysis_json)

    # 3) 生成
    final_text = llm_chat(
        system=sys_prompt,
        user=f"主題：{topic}\n目標：8-12 行，2-4 emoji"
    )
    return final_text
```

---

## 5. 是否要第三層「比對／優化」？

| 要素      | 適用情境                                       |
| ------- | ------------------------------------------ |
| **必要**  | 需要保證 <抄襲率上限>、<相似度下限>、<熵指標>；<br>或交付品質需自動把關。 |
| **可省略** | 產量不大、可人工複讀；對抄襲風險容忍度較高時。                    |

**實作**：
再加一支 `/audit` internal endpoint → 若不達標就 loop `build_system_prompt()` 調增 A/B 強度。

---

### ✨ 一句話

> **雙階段呼叫就在後端完成；第一階段 prompt 與分析 JSON 全部藏伺服器**。
> 客戶只打 `/generate`，永遠看不到分析細節，只拿到你依「A‑B‑C‑D 四層模型」動態生成的最終貼文。

###############

### 🔒 後端隱藏 A‑B‑C‑D 層、前端開放「貼文微調」—完整交互架構

```
                 ┌──────────────────────────┐
  Client UI ───► │  /generate  (POST)       │          ┌─────────────┐
(主題＋原文)     │  ————————————————        │          │  編輯頁面    │
                 │  ① internal /analyze    │───secret─│  (可改稿)    │
                 │  ② internal /write      │          └─────────────┘
                 └──────────────────────────┘
                                   │初稿JSON{text}
                                   ▼
                           傳回「貼文草稿」
```

---

## 1. 後端服務端點

| Endpoint      | 作用 & 對客戶可見 | 內容是否暴露 A‑B‑C‑D    |
| ------------- | ---------- | ----------------- |
| **/generate** | ✔ 客戶呼叫     | ❌（只返回草稿/metadata） |
| **/analyze**  | ❌ internal | 只在後端使用            |
| **/write**    | ❌ internal | 只在後端使用            |
| **/revise**   | ✔ 客戶呼叫     | ❌（只傳改動指令 + 新稿）    |

> * **A‑B‑C‑D** 相關 Prompt 全在 `/analyze` 內部。
> * `/write` 只輸出完成文本，不帶規則描述。

---

## 2. 客戶端「貼文微調」流程

1. **客戶呼叫 `/generate`** ➜ 取得 `草稿 v0`
2. 前端「編輯頁」呈現 `草稿 v0`，客戶可：

   * **直接手改**（富文本框）
   * 或輸入**對話式指令**（例：*「emoji 少一點、加入促銷連結」*）
3. 前端把 **差異化指令 / 手改全文** 送 `/revise`
4. 後端 `/revise` 以「草稿 v0 + 客戶指令」→ 單次 LLM 呼叫

   * 不引入 A‑B‑C‑D 層（已在 v0 中體現）
   * 僅做局部重寫、增刪、風格輕調
5. 返回 `草稿 v1` ➜ 前端覆蓋顯示
6. 客戶可循環 2‑5 次，直到滿意 ➜ **Publish**

---

## 3. `/revise` 具體 Prompt 設計

### System (固定、不暴露 A‑B‑C‑D)

```
你是一位貼文文案編輯助手。
按使用者說明，對現有貼文只做必要重寫或增減，
保留整體節奏，不透露任何模型或規則細節。
```

### User (由前端程式化組裝)

```
《原貼文》:
{{draft_v0}}

《修改需求》:
{{user_instruction}}   # 可能是「再幽默點」、「加 emoji」或手改後全文
```

> * 若使用者 **全手改** → 直接覆蓋草稿，不必調用 LLM。
> * 若使用者 **輸入自然語指令** → 呼叫 `/revise`。

---

## 4. 隱私與安全

* **A‑B‑C‑D Prompt** 存環境變數或私有檔案，僅 `/analyze` 取用。
* `/write` 與 `/revise` 均不返回任何 Prompt 或規則字串。
* 前端只拿到最終結果，無法逆推出隱藏邏輯。

---

## 5. 客戶體驗路徑

1. **「我要貼文」** → 輸入主題/素材 → 得到草稿
2. **「再調一下」** → 在同頁對草稿說話或手動編輯 → 一鍵更新
3. **「看起來 OK」** → 發布 / 複製

整個過程中，客戶永遠看不到 A‑B‑C‑D 分層策略，只體驗到「初稿品質高 + 可以即時對話式微調」的效果。
