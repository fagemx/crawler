## 📋 **完整爬蟲工作流程解析**

### **🎯 總體架構**
```
URL收集 → 數據填充 → 去重處理 → 補足機制 → 數據保存
```

---

## 🔄 **詳細流程分析**

### **階段1：初始化和準備** 
```
步驟1: 初始化瀏覽器和認證
步驟2: 獲取現有貼文ID和爬取狀態  
步驟3: 確定錨點貼文ID (用於增量爬取)
```

### **階段2：URL收集** 🌐
```
步驟4: 智能滾動收集URLs
├─ NEW模式: 從最新開始，直到遇到錨點
├─ HIST模式: 歷史回溯模式  
└─ 回退模式: 傳統URL提取器
```

**輸出**: `List[str]` URL列表

### **階段3：PostMetrics創建** 📝
```
步驟5: 轉換URLs為PostMetrics對象
├─ URL驗證 (過濾轉發貼文)
├─ 創建基礎PostMetrics結構
└─ 設定初始狀態: processing_stage="urls_extracted"
```

**輸出**: `List[PostMetrics]` 基礎對象列表

### **階段4：數據填充** 🔍
```
步驟5: DetailsExtractor - 混合策略補齊
├─ GraphQL攔截: likes, comments, reposts, shares
├─ DOM解析: content, images, videos  
├─ 新功能: post_published_at, tags ← 你的新欄位
└─ 更新processing_stage="details_filled_hybrid"

步驟6: ViewsExtractor - 補齊觀看數
├─ DOM選擇器策略: 多種views選擇器
├─ 數字解析: 86,900 → 86900
└─ 更新processing_stage="views_filled"
```

**輸出**: 完整的 `List[PostMetrics]` 

### **階段5：數據處理** 🛠️
```
步驟7: 去重處理
├─ 識別主貼文vs回應貼文
├─ 保留主貼文，過濾回應
└─ apply_deduplication()

步驟7.5: 補足機制 (如果不足目標數量)
├─ 檢查數量缺口
├─ 動態補足策略: 缺少數 × (2+輪次)
└─ 最多2輪補足
```

### **階段6：數據保存** 💾
```
步驟8: 保存調試數據
└─ 生成 crawl_data_YYYYMMDD_HHMMSS_taskid.json

步驟9: 數據庫存儲 ← 重要！
├─ 存儲到: post_metrics_sql 表
├─ UPSERT模式: 更新已存在的貼文
└─ 更新爬取狀態

步驟10: 生成任務指標
└─ 返回 PostMetricsBatch
```

---

## 📊 **數據組成分析**

### **🎯 JSON輸出格式**
```json
{
  "task_id": "71195057-115c-45af-ac98-a0872907fde4",
  "username": "natgeo", 
  "timestamp": "2025-08-03T08:34:23.460960",
  "total_found": 0,
  "returned_count": 11,
  "posts": [
    {
      "url": "https://www.threads.com/@natgeo/post/DM2oBhXqFcx",
      "post_id": "natgeo_DM2oBhXqFcx",
      "likes_count": 1229,
      "comments_count": 17, 
      "reposts_count": 20,
      "shares_count": 6,
      "views_count": 233000,
      "calculated_score": 233376.4,
      "content": "You ever get the impression...",
      "created_at": "2025-08-03T08:28:47.394419",        // 爬蟲處理時間
      "post_published_at": "2025-07-31T13:00:02+00:00",  // ← 新增！真實發文時間
      "tags": [],                                         // ← 新增！主題標籤
      "images": [...],
      "videos": [...]
    }
  ]
}
```

---

## 🗄️ **數據庫存儲狀況**

### ✅ **數據庫存儲完全支援！**
```sql
-- 存儲位置
TABLE: post_metrics_sql

-- 完整存儲欄位 (包含新欄位)
post_id, username, url, content,
likes_count, comments_count, reposts_count, shares_count, views_count,
calculated_score, images, videos, created_at, fetched_at, 
views_fetched_at, source, processing_stage, is_complete,
post_published_at,  -- ✅ 新增：真實發文時間
tags                -- ✅ 新增：主題標籤列表
```

### ✅ **已修復的問題**
```sql
-- ✅ common/history.py - SQL INSERT/UPDATE 語句已更新
INSERT INTO post_metrics_sql (
    ..., post_published_at, tags
) VALUES (
    ..., $19, $20
)

-- ✅ scripts/init-db.sql - 表結構已更新
post_published_at TIMESTAMPTZ,            -- 真實貼文發布時間
tags              JSONB DEFAULT '[]'      -- 主題標籤列表
```

### 🔄 **現有數據庫遷移**
如果你有現有的數據庫需要添加新欄位：

**方法1：使用Python腳本（推薦）**
```bash
python update_existing_database.py
```

**方法2：直接執行SQL**
```sql
-- 執行 add_new_columns_to_existing_db.sql
ALTER TABLE post_metrics_sql ADD COLUMN IF NOT EXISTS post_published_at TIMESTAMPTZ;
ALTER TABLE post_metrics_sql ADD COLUMN IF NOT EXISTS tags JSONB DEFAULT '[]';
```

---

## 📈 **流程優化建議**

### ✅ **已完成功能**
1. **✅ JSON輸出**：完全支援，包含新欄位 `post_published_at`, `tags`
2. **✅ 數據庫存儲**：已修復，新欄位可正確保存到 `post_metrics_sql` 表
3. **✅ 轉發過濾**：已修復，防止其他用戶的轉發貼文被誤認為目標用戶貼文
4. **✅ 時間提取**：多策略提取真實發文時間（DOM datetime, title/aria-label, __NEXT_DATA__, 相對時間解析）
5. **✅ 標籤提取**：基於標籤連結的精確提取，支援用戶指定的絕對標籤

### ⚠️ **待優化功能**
1. **⚠️ 數量控制**：待優化（目前會超額爬取，補足策略過於積極）
2. **🔄 錯誤處理**：可進一步增強異常情況的恢復機制

---

## 🚀 **部署指導**

### **新部署（推薦）**
```bash
# 一行命令完成所有更新
docker compose up -d --build
```
✅ 新部署會自動包含所有最新功能和數據庫結構

### **現有部署更新**
```bash
# 選項1：重建數據庫（簡單）
docker compose down
docker compose up -d --build

# 選項2：保留數據，只添加新欄位
python update_existing_database.py
docker compose up -d --build
```

### **驗證部署**
```bash
# 測試爬蟲功能
python test_playwright_agent.py

# 檢查Docker容器日誌
docker logs social-media-playwright-crawler -f
```

---

## 🎯 **完整功能清單**

### 📊 **數據提取能力**
- **基礎指標**：likes, comments, reposts, shares, views
- **內容數據**：text content, images, videos
- **時間數據**：crawler time (created_at) + post time (post_published_at)
- **標籤數據**：user-specified topic tags (tags)
- **計算指標**：calculated_score (綜合評分)

### 🔄 **處理流程**
- **智能收集**：滾動式URL收集，支援增量爬取
- **混合提取**：GraphQL攔截 + DOM解析雙重保障
- **數據清理**：去重處理，轉發過濾
- **完整存儲**：JSON輸出 + PostgreSQL數據庫

**🎉 數據庫注入功能已完成！新欄位現在會自動保存到數據庫中。**