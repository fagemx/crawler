## ğŸ“‹ **å®Œæ•´çˆ¬èŸ²å·¥ä½œæµç¨‹è§£æ**

### **ğŸ¯ ç¸½é«”æ¶æ§‹**
```
URLæ”¶é›† â†’ æ•¸æ“šå¡«å…… â†’ å»é‡è™•ç† â†’ è£œè¶³æ©Ÿåˆ¶ â†’ æ•¸æ“šä¿å­˜
```

---

## ğŸ”„ **è©³ç´°æµç¨‹åˆ†æ**

### **éšæ®µ1ï¼šåˆå§‹åŒ–å’Œæº–å‚™** 
```
æ­¥é©Ÿ1: åˆå§‹åŒ–ç€è¦½å™¨å’Œèªè­‰
æ­¥é©Ÿ2: ç²å–ç¾æœ‰è²¼æ–‡IDå’Œçˆ¬å–ç‹€æ…‹  
æ­¥é©Ÿ3: ç¢ºå®šéŒ¨é»è²¼æ–‡ID (ç”¨æ–¼å¢é‡çˆ¬å–)
```

### **éšæ®µ2ï¼šURLæ”¶é›†** ğŸŒ
```
æ­¥é©Ÿ4: æ™ºèƒ½æ»¾å‹•æ”¶é›†URLs
â”œâ”€ NEWæ¨¡å¼: å¾æœ€æ–°é–‹å§‹ï¼Œç›´åˆ°é‡åˆ°éŒ¨é»
â”œâ”€ HISTæ¨¡å¼: æ­·å²å›æº¯æ¨¡å¼  
â””â”€ å›é€€æ¨¡å¼: å‚³çµ±URLæå–å™¨
```

**è¼¸å‡º**: `List[str]` URLåˆ—è¡¨

### **éšæ®µ3ï¼šPostMetricså‰µå»º** ğŸ“
```
æ­¥é©Ÿ5: è½‰æ›URLsç‚ºPostMetricså°è±¡
â”œâ”€ URLé©—è­‰ (éæ¿¾è½‰ç™¼è²¼æ–‡)
â”œâ”€ å‰µå»ºåŸºç¤PostMetricsçµæ§‹
â””â”€ è¨­å®šåˆå§‹ç‹€æ…‹: processing_stage="urls_extracted"
```

**è¼¸å‡º**: `List[PostMetrics]` åŸºç¤å°è±¡åˆ—è¡¨

### **éšæ®µ4ï¼šæ•¸æ“šå¡«å……** ğŸ”
```
æ­¥é©Ÿ5: DetailsExtractor - æ··åˆç­–ç•¥è£œé½Š
â”œâ”€ GraphQLæ””æˆª: likes, comments, reposts, shares
â”œâ”€ DOMè§£æ: content, images, videos  
â”œâ”€ æ–°åŠŸèƒ½: post_published_at, tags â† ä½ çš„æ–°æ¬„ä½
â””â”€ æ›´æ–°processing_stage="details_filled_hybrid"

æ­¥é©Ÿ6: ViewsExtractor - è£œé½Šè§€çœ‹æ•¸
â”œâ”€ DOMé¸æ“‡å™¨ç­–ç•¥: å¤šç¨®viewsé¸æ“‡å™¨
â”œâ”€ æ•¸å­—è§£æ: 86,900 â†’ 86900
â””â”€ æ›´æ–°processing_stage="views_filled"
```

**è¼¸å‡º**: å®Œæ•´çš„ `List[PostMetrics]` 

### **éšæ®µ5ï¼šæ•¸æ“šè™•ç†** ğŸ› ï¸
```
æ­¥é©Ÿ7: å»é‡è™•ç†
â”œâ”€ è­˜åˆ¥ä¸»è²¼æ–‡vså›æ‡‰è²¼æ–‡
â”œâ”€ ä¿ç•™ä¸»è²¼æ–‡ï¼Œéæ¿¾å›æ‡‰
â””â”€ apply_deduplication()

æ­¥é©Ÿ7.5: è£œè¶³æ©Ÿåˆ¶ (å¦‚æœä¸è¶³ç›®æ¨™æ•¸é‡)
â”œâ”€ æª¢æŸ¥æ•¸é‡ç¼ºå£
â”œâ”€ å‹•æ…‹è£œè¶³ç­–ç•¥: ç¼ºå°‘æ•¸ Ã— (2+è¼ªæ¬¡)
â””â”€ æœ€å¤š2è¼ªè£œè¶³
```

### **éšæ®µ6ï¼šæ•¸æ“šä¿å­˜** ğŸ’¾
```
æ­¥é©Ÿ8: ä¿å­˜èª¿è©¦æ•¸æ“š
â””â”€ ç”Ÿæˆ crawl_data_YYYYMMDD_HHMMSS_taskid.json

æ­¥é©Ÿ9: æ•¸æ“šåº«å­˜å„² â† é‡è¦ï¼
â”œâ”€ å­˜å„²åˆ°: post_metrics_sql è¡¨
â”œâ”€ UPSERTæ¨¡å¼: æ›´æ–°å·²å­˜åœ¨çš„è²¼æ–‡
â””â”€ æ›´æ–°çˆ¬å–ç‹€æ…‹

æ­¥é©Ÿ10: ç”Ÿæˆä»»å‹™æŒ‡æ¨™
â””â”€ è¿”å› PostMetricsBatch
```

---

## ğŸ“Š **æ•¸æ“šçµ„æˆåˆ†æ**

### **ğŸ¯ JSONè¼¸å‡ºæ ¼å¼**
```json
{
  "task_id": "71195057-115c-45af-ac98-a0872907fde4",
  "username": "natgeo", 
  "timestamp": "2025-08-03T08:34:23.460960",
  "total_found": 0,
  "returned_count": 11,
  "posts": [
    {
      "url": "https://www.threads.com/@natgeo/post/DM2oBhXqFcx",
      "post_id": "natgeo_DM2oBhXqFcx",
      "likes_count": 1229,
      "comments_count": 17, 
      "reposts_count": 20,
      "shares_count": 6,
      "views_count": 233000,
      "calculated_score": 233376.4,
      "content": "You ever get the impression...",
      "created_at": "2025-08-03T08:28:47.394419",        // çˆ¬èŸ²è™•ç†æ™‚é–“
      "post_published_at": "2025-07-31T13:00:02+00:00",  // â† æ–°å¢ï¼çœŸå¯¦ç™¼æ–‡æ™‚é–“
      "tags": [],                                         // â† æ–°å¢ï¼ä¸»é¡Œæ¨™ç±¤
      "images": [...],
      "videos": [...]
    }
  ]
}
```

---

## ğŸ—„ï¸ **æ•¸æ“šåº«å­˜å„²ç‹€æ³**

### âœ… **æ•¸æ“šåº«å­˜å„²å®Œå…¨æ”¯æ´ï¼**
```sql
-- å­˜å„²ä½ç½®
TABLE: post_metrics_sql

-- å®Œæ•´å­˜å„²æ¬„ä½ (åŒ…å«æ–°æ¬„ä½)
post_id, username, url, content,
likes_count, comments_count, reposts_count, shares_count, views_count,
calculated_score, images, videos, created_at, fetched_at, 
views_fetched_at, source, processing_stage, is_complete,
post_published_at,  -- âœ… æ–°å¢ï¼šçœŸå¯¦ç™¼æ–‡æ™‚é–“
tags                -- âœ… æ–°å¢ï¼šä¸»é¡Œæ¨™ç±¤åˆ—è¡¨
```

### âœ… **å·²ä¿®å¾©çš„å•é¡Œ**
```sql
-- âœ… common/history.py - SQL INSERT/UPDATE èªå¥å·²æ›´æ–°
INSERT INTO post_metrics_sql (
    ..., post_published_at, tags
) VALUES (
    ..., $19, $20
)

-- âœ… scripts/init-db.sql - è¡¨çµæ§‹å·²æ›´æ–°
post_published_at TIMESTAMPTZ,            -- çœŸå¯¦è²¼æ–‡ç™¼å¸ƒæ™‚é–“
tags              JSONB DEFAULT '[]'      -- ä¸»é¡Œæ¨™ç±¤åˆ—è¡¨
```

### ğŸ”„ **ç¾æœ‰æ•¸æ“šåº«é·ç§»**
å¦‚æœä½ æœ‰ç¾æœ‰çš„æ•¸æ“šåº«éœ€è¦æ·»åŠ æ–°æ¬„ä½ï¼š

**æ–¹æ³•1ï¼šä½¿ç”¨Pythonè…³æœ¬ï¼ˆæ¨è–¦ï¼‰**
```bash
python update_existing_database.py
```

**æ–¹æ³•2ï¼šç›´æ¥åŸ·è¡ŒSQL**
```sql
-- åŸ·è¡Œ add_new_columns_to_existing_db.sql
ALTER TABLE post_metrics_sql ADD COLUMN IF NOT EXISTS post_published_at TIMESTAMPTZ;
ALTER TABLE post_metrics_sql ADD COLUMN IF NOT EXISTS tags JSONB DEFAULT '[]';
```

---

## ğŸ“ˆ **æµç¨‹å„ªåŒ–å»ºè­°**

### âœ… **å·²å®ŒæˆåŠŸèƒ½**
1. **âœ… JSONè¼¸å‡º**ï¼šå®Œå…¨æ”¯æ´ï¼ŒåŒ…å«æ–°æ¬„ä½ `post_published_at`, `tags`
2. **âœ… æ•¸æ“šåº«å­˜å„²**ï¼šå·²ä¿®å¾©ï¼Œæ–°æ¬„ä½å¯æ­£ç¢ºä¿å­˜åˆ° `post_metrics_sql` è¡¨
3. **âœ… è½‰ç™¼éæ¿¾**ï¼šå·²ä¿®å¾©ï¼Œé˜²æ­¢å…¶ä»–ç”¨æˆ¶çš„è½‰ç™¼è²¼æ–‡è¢«èª¤èªç‚ºç›®æ¨™ç”¨æˆ¶è²¼æ–‡
4. **âœ… æ™‚é–“æå–**ï¼šå¤šç­–ç•¥æå–çœŸå¯¦ç™¼æ–‡æ™‚é–“ï¼ˆDOM datetime, title/aria-label, __NEXT_DATA__, ç›¸å°æ™‚é–“è§£æï¼‰
5. **âœ… æ¨™ç±¤æå–**ï¼šåŸºæ–¼æ¨™ç±¤é€£çµçš„ç²¾ç¢ºæå–ï¼Œæ”¯æ´ç”¨æˆ¶æŒ‡å®šçš„çµ•å°æ¨™ç±¤

### âš ï¸ **å¾…å„ªåŒ–åŠŸèƒ½**
1. **âš ï¸ æ•¸é‡æ§åˆ¶**ï¼šå¾…å„ªåŒ–ï¼ˆç›®å‰æœƒè¶…é¡çˆ¬å–ï¼Œè£œè¶³ç­–ç•¥éæ–¼ç©æ¥µï¼‰
2. **ğŸ”„ éŒ¯èª¤è™•ç†**ï¼šå¯é€²ä¸€æ­¥å¢å¼·ç•°å¸¸æƒ…æ³çš„æ¢å¾©æ©Ÿåˆ¶

---

## ğŸš€ **éƒ¨ç½²æŒ‡å°**

### **æ–°éƒ¨ç½²ï¼ˆæ¨è–¦ï¼‰**
```bash
# ä¸€è¡Œå‘½ä»¤å®Œæˆæ‰€æœ‰æ›´æ–°
docker compose up -d --build
```
âœ… æ–°éƒ¨ç½²æœƒè‡ªå‹•åŒ…å«æ‰€æœ‰æœ€æ–°åŠŸèƒ½å’Œæ•¸æ“šåº«çµæ§‹

### **ç¾æœ‰éƒ¨ç½²æ›´æ–°**
```bash
# é¸é …1ï¼šé‡å»ºæ•¸æ“šåº«ï¼ˆç°¡å–®ï¼‰
docker compose down
docker compose up -d --build

# é¸é …2ï¼šä¿ç•™æ•¸æ“šï¼Œåªæ·»åŠ æ–°æ¬„ä½
python update_existing_database.py
docker compose up -d --build
```

### **é©—è­‰éƒ¨ç½²**
```bash
# æ¸¬è©¦çˆ¬èŸ²åŠŸèƒ½
python test_playwright_agent.py

# æª¢æŸ¥Dockerå®¹å™¨æ—¥èªŒ
docker logs social-media-playwright-crawler -f
```

---

## ğŸ¯ **å®Œæ•´åŠŸèƒ½æ¸…å–®**

### ğŸ“Š **æ•¸æ“šæå–èƒ½åŠ›**
- **åŸºç¤æŒ‡æ¨™**ï¼šlikes, comments, reposts, shares, views
- **å…§å®¹æ•¸æ“š**ï¼štext content, images, videos
- **æ™‚é–“æ•¸æ“š**ï¼šcrawler time (created_at) + post time (post_published_at)
- **æ¨™ç±¤æ•¸æ“š**ï¼šuser-specified topic tags (tags)
- **è¨ˆç®—æŒ‡æ¨™**ï¼šcalculated_score (ç¶œåˆè©•åˆ†)

### ğŸ”„ **è™•ç†æµç¨‹**
- **æ™ºèƒ½æ”¶é›†**ï¼šæ»¾å‹•å¼URLæ”¶é›†ï¼Œæ”¯æ´å¢é‡çˆ¬å–
- **æ··åˆæå–**ï¼šGraphQLæ””æˆª + DOMè§£æé›™é‡ä¿éšœ
- **æ•¸æ“šæ¸…ç†**ï¼šå»é‡è™•ç†ï¼Œè½‰ç™¼éæ¿¾
- **å®Œæ•´å­˜å„²**ï¼šJSONè¼¸å‡º + PostgreSQLæ•¸æ“šåº«

**ğŸ‰ æ•¸æ“šåº«æ³¨å…¥åŠŸèƒ½å·²å®Œæˆï¼æ–°æ¬„ä½ç¾åœ¨æœƒè‡ªå‹•ä¿å­˜åˆ°æ•¸æ“šåº«ä¸­ã€‚**