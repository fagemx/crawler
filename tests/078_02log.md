æˆ‘ä¾†ç‚ºæ‚¨è©³ç´°èªªæ˜æ“ä½œæ—¥èªŒèˆ‡éŒ¯èª¤è¨˜éŒ„åŠŸèƒ½çš„å¯¦ç¾ä½ç½®å’Œé«”ç¾æ–¹å¼ã€‚è®“æˆ‘æª¢æŸ¥ç›¸é—œçš„æª”æ¡ˆä¾†å±•ç¤ºé€™äº›åŠŸèƒ½ï¼š
Search files...
Search files...
Read file: database/schema_planE.sql
ç¾åœ¨è®“æˆ‘é€²ä¸€æ­¥æª¢æŸ¥æ“ä½œæ—¥èªŒçš„å…·é«”å¯¦ç¾ï¼š
Ran tool
Ran tool
Read file: common/db_client.py
Read file: common/db_client.py
Read file: mcp_server/server.py
è®“æˆ‘å†æª¢æŸ¥æ›´å¤šæ“ä½œæ—¥èªŒçš„å¯¦ç¾ç´°ç¯€ï¼š
Read file: mcp_server/models.py
Ran tool
ç¾åœ¨æˆ‘å¯ä»¥ç‚ºæ‚¨è©³ç´°èªªæ˜æ“ä½œæ—¥èªŒèˆ‡éŒ¯èª¤è¨˜éŒ„åŠŸèƒ½çš„å¯¦ç¾ä½ç½®å’Œé«”ç¾æ–¹å¼ï¼š

## ğŸ” **æ“ä½œæ—¥èªŒèˆ‡éŒ¯èª¤è¨˜éŒ„åŠŸèƒ½ - å®Œæ•´å¯¦ç¾ä½ç½®**

### **1. è³‡æ–™åº«å±¤é¢ Schema è¨­è¨ˆ**

**ä½ç½®ï¼š`database/schema_planE.sql`**

```sql
-- ğŸ“‹ Agent è™•ç†è¨˜éŒ„ (ç¬¬42-53è¡Œ)
CREATE TABLE processing_log (
    id           SERIAL PRIMARY KEY,
    url          TEXT NOT NULL,
    agent_name   TEXT NOT NULL,
    stage        TEXT NOT NULL,  -- 'markdown', 'vision_fill', 'analysis'
    status       TEXT NOT NULL,  -- 'pending', 'completed', 'failed'
    started_at   TIMESTAMPTZ DEFAULT now(),
    completed_at TIMESTAMPTZ,
    error_msg    TEXT,
    metadata     JSONB
);

-- ğŸ“Š ç³»çµ±æ“ä½œæ—¥èªŒ (ç¬¬92-110è¡Œ)
CREATE TABLE system_operation_log (
    id              SERIAL PRIMARY KEY,
    operation_type  TEXT NOT NULL,  -- 'agent_register', 'health_check', 'task_execute'
    operation_name  TEXT NOT NULL,
    agent_name      TEXT,
    status          TEXT NOT NULL CHECK (status IN ('success', 'failed', 'pending')),
    request_data    JSONB,
    response_data   JSONB,
    error_message   TEXT,
    execution_time_ms INTEGER,
    started_at      TIMESTAMPTZ DEFAULT now(),
    completed_at    TIMESTAMPTZ
);

-- âš ï¸ ç³»çµ±éŒ¯èª¤è¨˜éŒ„ (ç¬¬110-128è¡Œ)
CREATE TABLE system_error_log (
    id              SERIAL PRIMARY KEY,
    error_type      TEXT NOT NULL,  -- 'agent_error', 'database_error', 'network_error'
    error_message   TEXT NOT NULL,
    stack_trace     TEXT,
    agent_name      TEXT,
    severity        TEXT DEFAULT 'error',
    occurred_at     TIMESTAMPTZ DEFAULT now(),
    resolved_at     TIMESTAMPTZ,
    metadata        JSONB DEFAULT '{}'
);
```

### **2. è³‡æ–™åº«å®¢æˆ¶ç«¯å¯¦ç¾**

**ä½ç½®ï¼š`common/db_client.py` (ç¬¬619-695è¡Œ)**

```python
async def log_processing(
    self,
    url: str,
    agent_name: str,
    stage: str,
    status: str,
    error_msg: Optional[str] = None,
    metadata: Optional[Dict[str, Any]] = None
) -> bool:
    """è¨˜éŒ„è™•ç†æ—¥èªŒ - è¿½è¹¤æ¯å€‹ Agent çš„è™•ç†éšæ®µ"""
    try:
        metadata_json = json.dumps(metadata) if metadata is not None else None
        async with self.get_connection() as conn:
            await conn.execute("""
                INSERT INTO processing_log 
                (url, agent_name, stage, status, error_msg, metadata, started_at)
                VALUES ($1, $2, $3, $4, $5, $6, $7)
            """, url, agent_name, stage, status, error_msg, metadata_json, datetime.utcnow())
            
        return True
    except Exception as e:
        print(f"è¨˜éŒ„è™•ç†æ—¥èªŒå¤±æ•— {url}: {e}")
        return False
```

### **3. Agent å±¤é¢çš„æ—¥èªŒè¨˜éŒ„**

**ä½ç½®ï¼š`agents/jina_markdown/jina_markdown_logic.py` (ç¬¬228-240è¡Œ)**

```python
# âœ… æˆåŠŸæ™‚è¨˜éŒ„è©³ç´°è³‡è¨Š
await db_client.log_processing(
    url=post_url,
    agent_name="jina_markdown",
    stage="markdown_extraction",
    status="completed" if not needs_vision else "needs_vision",
    metadata={
        "metrics_extracted": len([v for v in metrics.values() if v is not None]),
        "missing_fields": missing_fields,
        "redis_written": redis_success,
        "markdown_length": len(markdown_text),
        "media_count": len(media_urls) if media_urls else 0
    }
)

# âŒ éŒ¯èª¤æ™‚è¨˜éŒ„å¤±æ•—è³‡è¨Š (ç¬¬257-266è¡Œ)
await db_client.log_processing(
    url=post_url,
    agent_name="jina_markdown",
    stage="markdown_extraction",
    status="failed",
    error_msg=str(e)
)
```

**ä½ç½®ï¼š`agents/jina/jina_logic.py` (ç¬¬208-220è¡Œ)**

```python
# ğŸ“ Jina Agent ä¹Ÿæœ‰é¡ä¼¼çš„æ—¥èªŒè¨˜éŒ„
await db_client.log_processing(
    url=post_url,
    agent_name="jina",
    stage="markdown_processing",
    status="completed",
    metadata={
        "metrics_found": len([v for v in metrics.values() if v is not None]),
        "missing_metrics": missing_fields,
        "needs_vision": needs_vision
    }
)
```

### **4. MCP Server å±¤é¢çš„æ“ä½œæ—¥èªŒ**

**ä½ç½®ï¼š`mcp_server/server.py` (ç¬¬720-750è¡Œ)**

```python
@app.get("/system/logs")
async def get_system_logs(
    operation_type: Optional[str] = None,
    agent_name: Optional[str] = None,
    limit: int = 100
):
    """ç²å–ç³»çµ±æ“ä½œæ—¥èªŒ - API ç«¯é»"""
    try:
        async with mcp_server.db_client.get_connection() as conn:
            query = """
                SELECT id, operation_type, operation_name, agent_name, status,
                       error_message, execution_time_ms, started_at, completed_at
                FROM system_operation_log
                WHERE 1=1
            """
            # ... æŸ¥è©¢é‚è¼¯
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/system/errors")
async def get_system_errors(
    error_type: Optional[str] = None,
    severity: Optional[str] = None,
    limit: int = 100
):
    """ç²å–ç³»çµ±éŒ¯èª¤è¨˜éŒ„ - API ç«¯é»"""
```

### **5. SQLAlchemy æ¨¡å‹å®šç¾©**

**ä½ç½®ï¼š`mcp_server/models.py` (ç¬¬62-95è¡Œ)**

```python
class OpsLog(SQLModel, table=True):
    """æ“ä½œæ—¥èªŒ - æ¨™æº–åŒ–æ¨¡å‹"""
    __tablename__ = "system_operation_log"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    ts: datetime = Field(default_factory=datetime.utcnow, index=True)
    agent: Optional[str] = Field(default=None, index=True)
    operation_type: str = Field(index=True)  # register/heartbeat/media_download
    operation_name: str
    level: str = Field(default="INFO")  # INFO/WARN/ERROR
    message: str
    status: str = Field(default="success")  # success/failed/pending
    execution_time_ms: Optional[int] = None
    extra: Dict[str, Any] = Field(default_factory=dict)

class ErrorLog(SQLModel, table=True):
    """éŒ¯èª¤æ—¥èªŒ - è©³ç´°è¿½è¹¤æ¨¡å‹"""
    __tablename__ = "system_error_log"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    ts: datetime = Field(default_factory=datetime.utcnow, index=True)
    agent: Optional[str] = Field(default=None, index=True)
    error_type: str = Field(index=True)  # agent_error/media_error/database_error
    error_message: str
    traceback: Optional[str] = None
    severity: str = Field(default="error")  # debug/info/warning/error/critical
```

## ğŸ¯ **æ—¥èªŒåŠŸèƒ½åœ¨è²¼æ–‡åˆ†ææµç¨‹ä¸­çš„é«”ç¾**

### **å®Œæ•´çš„è¿½è¹¤éˆæ¢ï¼š**

1. **ğŸ“‹ è™•ç†æ—¥èªŒ** (`processing_log`)
   - æ¯å€‹ Agent è™•ç†æ¯å€‹è²¼æ–‡æ™‚éƒ½æœƒè¨˜éŒ„
   - åŒ…å«éšæ®µã€ç‹€æ…‹ã€å…ƒæ•¸æ“šã€éŒ¯èª¤è¨Šæ¯
   - **ç”¨é€”ï¼š** è¿½è¹¤è²¼æ–‡å¾æŠ“å–åˆ°åˆ†æçš„å®Œæ•´æµç¨‹

2. **ğŸ“Š ç³»çµ±æ“ä½œæ—¥èªŒ** (`system_operation_log`)
   - è¨˜éŒ„ MCP Server çš„æ‰€æœ‰æ“ä½œ
   - Agent è¨»å†Šã€å¥åº·æª¢æŸ¥ã€ä»»å‹™åŸ·è¡Œ
   - **ç”¨é€”ï¼š** ç³»çµ±é‹ç¶­å’Œæ€§èƒ½ç›£æ§

3. **âš ï¸ éŒ¯èª¤è¨˜éŒ„** (`system_error_log`)
   - è©³ç´°çš„éŒ¯èª¤è¿½è¹¤å’Œå †ç–Šè³‡è¨Š
   - æŒ‰åš´é‡ç¨‹åº¦åˆ†é¡
   - **ç”¨é€”ï¼š** å•é¡Œè¨ºæ–·å’Œæ•…éšœæ’é™¤

### **å¯¦éš›æµç¨‹è¿½è¹¤ç¯„ä¾‹ï¼š**

```
è²¼æ–‡URL: https://threads.net/example/post
â”‚
â”œâ”€â”€ ğŸ“‹ processing_log: jina_markdown â†’ markdown_extraction â†’ completed
â”œâ”€â”€ ğŸ“‹ processing_log: vision â†’ vision_fill â†’ pending
â”œâ”€â”€ ğŸ“Š system_operation_log: health_check â†’ vision_agent â†’ success
â””â”€â”€ âš ï¸ system_error_log: network_error â†’ vision_agent â†’ warning
```

**é€™å¥—æ—¥èªŒç³»çµ±è®“æ‚¨èƒ½å¤ ï¼š**
- âœ… è¿½è¹¤æ¯å€‹è²¼æ–‡çš„å®Œæ•´è™•ç†éç¨‹
- âœ… ç›£æ§ Agent çš„å¥åº·ç‹€æ…‹å’Œæ€§èƒ½
- âœ… å¿«é€Ÿå®šä½å’Œè¨ºæ–·å•é¡Œ
- âœ… ç”Ÿæˆè©³ç´°çš„è™•ç†å ±å‘Š
- âœ… æ”¯æ´å¾ŒçºŒçš„åˆ†æå’Œå„ªåŒ–

é€™å°±æ˜¯ç‚ºä»€éº¼åœ¨ `test_mcp_complete.py` ä¸­æåˆ°çš„"æ“ä½œå¯©è¨ˆèˆ‡æ—¥èªŒè¿½è¹¤"åŠŸèƒ½ï¼Œå·²ç¶“å®Œæ•´å¯¦ç¾ä¸¦ä¸Šç·šé‹è¡Œäº†ï¼