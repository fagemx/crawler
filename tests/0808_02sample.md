懂了。你不是要我複製「A層」，而是要**把那種嚴謹、可機器驗證的轉化規則**套在你的四階段流程裡，讓每一階段都**直接產出可用 JSON**，下游可以拿去「改寫/生成」而不是再讀散文式分析。

下面給你「宏觀到微觀」的一套：**雙呼叫架構 + 每階段 System Prompt 重構 + 嚴格 JSON Schema + 一點一致性校驗規則**。你可以原封不動嵌到 pipeline。

---

# 架構總覽（兩次 LLM 調用）

* **Call #1：模式分組 + 結構統計（合併）**
  輸入：25–100 篇貼文（或其預處理摘要）
  輸出：`patterns[]`（互斥模式 + 結構統計指紋），以及整體 `analysis_summary`
* **Call #2：創作模板 + 統合指南（合併）**
  輸入：Call #1 的 `patterns[]` + 業務約束
  輸出：每模式一份 `creation_template`（生成就緒）+ `unified_guide`（跨模式策略）

---

# Call #1：模式分組 + 結構統計（系統提示精煉版）

**目標**：把原始貼文分成 3–5 個**互斥模式**，並輸出**機器可用**的結構指紋。**只輸出 JSON**，不可有其他字。

## JSON Schema（簡化要點版）

* 只列核心欄位；你可以用此骨架做 Pydantic 校驗。

```json
{
  "type": "object",
  "required": ["analysis_summary", "patterns"],
  "properties": {
    "analysis_summary": {
      "type": "object",
      "required": ["total_posts", "pattern_count", "min_samples_per_pattern", "merged_rules"],
      "properties": {
        "total_posts": {"type": "integer", "minimum": 1},
        "pattern_count": {"type": "integer", "minimum": 1, "maximum": 5},
        "min_samples_per_pattern": {"type": "integer", "minimum": 1},
        "merged_rules": {"type": "string"}
      }
    },
    "patterns": {
      "type": "array",
      "minItems": 3,
      "maxItems": 5,
      "items": {
        "type": "object",
        "required": [
          "pattern_id", "pattern_name", "post_indices", "post_count",
          "content_intent", "structure_type", "pragmatics",
          "structure_stats", "style_markers", "sample_previews"
        ],
        "properties": {
          "pattern_id": {"type": "string", "pattern": "^[A-E]$"},
          "pattern_name": {"type": "string"},
          "post_indices": {"type": "array", "items": {"type": "integer", "minimum": 0}},
          "post_count": {"type": "integer", "minimum": 8},
          "content_intent": {
            "type": "string",
            "enum": ["情感分享","資訊傳達","商品推薦","觀點表達","互動引導","行動號召"]
          },
          "structure_type": {
            "type": "string",
            "enum": ["單句型","多句型","列點型","對話型","敘事型","問答型"]
          },
          "pragmatics": {
            "type": "array",
            "items": {
              "type": "string",
              "enum": ["直述","感嘆","疑問","祈使","引用","比較"]
            }
          },
          "structure_stats": {
            "type": "object",
            "required": ["length_bucket","sentence_types","paragraphing","connectors","symbols","pace","cta_strength"],
            "properties": {
              "length_bucket": {"type": "string", "enum": ["短文(≤30字)","中長文(>30字)"]},
              "sentence_types": {
                "type": "object",
                "required": ["陳述","疑問","感嘆","祈使"],
                "properties": {
                  "陳述": {"type": "integer","minimum":0,"maximum":100},
                  "疑問": {"type": "integer","minimum":0,"maximum":100},
                  "感嘆": {"type": "integer","minimum":0,"maximum":100},
                  "祈使": {"type": "integer","minimum":0,"maximum":100}
                }
              },
              "paragraphing": {"type": "string", "enum": ["單段","多段","列點"]},
              "connectors": {
                "type": "string",
                "enum": ["逗號串聯","句號分隔","換行分割","混合"]
              },
              "symbols": {
                "type": "object",
                "required": ["emoji_rate","hashtag_rate","punctuation_density"],
                "properties": {
                  "emoji_rate": {"type": "string","pattern":"^[0-9]+(\\.[0-9])?%$"},
                  "hashtag_rate": {"type": "string","pattern":"^[0-9]+(\\.[0-9])?%$"},
                  "punctuation_density": {"type": "string","pattern":"^[0-9]+(\\.[0-9])?/句$"}
                }
              },
              "pace": {"type": "string","enum":["急促","舒緩","停頓","混合"]},
              "cta_strength": {"type": "string","enum":["強","中","弱","無"]}
            }
          },
          "style_markers": {
            "type": "object",
            "required": ["core_vocab","tone","do_nots"],
            "properties": {
              "core_vocab": {"type": "array", "items": {"type": "string"}},
              "tone": {"type": "string"},
              "do_nots": {"type": "array","items":{"type":"string"}}
            }
          },
          "sample_previews": {"type": "array","items":{"type":"string"}}
        }
      }
    }
  }
}
```

### 關鍵規則（放進 System Prompt）

* 所有 `post_indices` **不可重疊**，聯集大小 = `analysis_summary.total_posts`。
* 每個 `sentence_types` 百分比**總和 100±1%**（允許四捨五入漂移）。
* 若任一模式 `post_count < min_samples_per_pattern`，必須合併並在 `analysis_summary.merged_rules` 說明。
* `length_bucket` 決定後續欄位解讀（短文看符號/語氣，長文看段落/連接/敘事）。

---

# Call #2：每模式創作模板 + 統合指南（系統提示精煉版）

**目標**：把 Call #1 的模式指紋，轉為**能直接驅動生成**的模板 JSON。**只輸出 JSON**。

## JSON Schema（可生成用）

```json
{
  "type": "object",
  "required": ["templates","unified_guide"],
  "properties": {
    "templates": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "pattern_id","template_type","length_range",
          "writing_steps","style_guide","sentence_molds","guardrails","variability_knobs"
        ],
        "properties": {
          "pattern_id": {"type": "string","pattern":"^[A-E]$"},
          "template_type": {
            "type":"string",
            "enum":["one_liner","narrative","line_break_list","question_interactive"]
          },
          "length_range": {"type":"string","pattern":"^[0-9]+-[0-9]+字$|^≤[0-9]+字$"},
          "writing_steps": {
            "type":"array",
            "items":{"type":"string"},
            "minItems": 3
          },
          "style_guide": {
            "type":"object",
            "required": ["tone","sentence_mix","symbols","cta_rule"],
            "properties": {
              "tone": {"type":"string"},
              "sentence_mix": {
                "type":"object",
                "required":["short_ratio","long_ratio"],
                "properties": {
                  "short_ratio":{"type":"string","pattern":"^[0-9]+%$"},
                  "long_ratio":{"type":"string","pattern":"^[0-9]+%$"}
                }
              },
              "symbols": {
                "type":"object",
                "required":["emoji_rate","hashtag_rate","punctuation_density"],
                "properties": {
                  "emoji_rate":{"type":"string","pattern":"^[0-9]+(\\.[0-9])?%$"},
                  "hashtag_rate":{"type":"string","pattern":"^[0-9]+(\\.[0-9])?%$"},
                  "punctuation_density":{"type":"string","pattern":"^[0-9]+(\\.[0-9])?/句$"}
                }
              },
              "cta_rule":{"type":"string"}
            }
          },
          "sentence_molds": {
            "type":"array",
            "minItems": 4,
            "items": {
              "type":"object",
              "required":["purpose","pattern","example"],
              "properties": {
                "purpose":{"type":"string"},
                "pattern":{"type":"string"}, 
                "example":{"type":"string"}
              }
            }
          },
          "guardrails": {
            "type":"object",
            "required":["must_include","must_avoid","consistency_checks"],
            "properties": {
              "must_include":{"type":"array","items":{"type":"string"}},
              "must_avoid":{"type":"array","items":{"type":"string"}},
              "consistency_checks":{"type":"array","items":{"type":"string"}}
            }
          },
          "variability_knobs": {
            "type":"object",
            "required":["lexical","syntax","structure","attention","entropy"],
            "properties": {
              "lexical":{"type":"string","pattern":"^每[0-9]+(-[0-9]+)?句一次$"},
              "syntax":{"type":"string","pattern":"^每[0-9]+(-[0-9]+)?句一次$"},
              "structure":{"type":"string","pattern":"^每[0-9]+(-[0-9]+)?篇一次$"},
              "attention":{"type":"string","pattern":"^每[0-9]+(-[0-9]+)?段一次$"},
              "entropy": {
                "type":"object",
                "required":["high","mid","low","unpred"],
                "properties": {
                  "high":{"type":"string","pattern":"^[0-9]+%$"},
                  "mid":{"type":"string","pattern":"^[0-9]+%$"},
                  "low":{"type":"string","pattern":"^[0-9]+%$"},
                  "unpred":{"type":"string","pattern":"^[0-9]+%$"}
                }
              }
            }
          }
        }
      }
    },
    "unified_guide": {
      "type":"object",
      "required":["pattern_selection","cross_pattern_techniques","optimization_tips"],
      "properties": {
        "pattern_selection": {
          "type":"array",
          "items": {
            "type":"object",
            "required":["if_context","then_use_pattern","because"],
            "properties": {
              "if_context":{"type":"string"},
              "then_use_pattern":{"type":"string","pattern":"^[A-E]$"},
              "because":{"type":"string"}
            }
          }
        },
        "cross_pattern_techniques": {"type":"array","items":{"type":"string"}},
        "optimization_tips": {"type":"array","items":{"type":"string"}}
      }
    }
  }
}
```

### 一致性規則（放進 System Prompt）

* `sentence_mix.short_ratio + long_ratio = 100±1%`。
* `variability_knobs.entropy` 的四個比例總和 `= 100±1%`。
* `template_type` 必須**與 Call #1 的 `structure_type` 可對應**：

  * 單句型→one\_liner；敘事型→narrative；列點型→line\_break\_list；問答/互動→question\_interactive（或 narrative+問答段）。
* `guardrails.must_avoid` 必須包含 Call #1 的 `style_markers.do_nots`。
* `symbols.*` 與 Call #1 的 `structure_stats.symbols` **數值範圍要相容**（可 ±20% 浮動；超出要在模板內說明原因/場景）。

---

# 你要的「嚴謹轉化」怎麼嵌到現有四階段

* 你的四階段概念保持不變；只是把**第二階段輸出**與**第三、四階段輸出**做成**兩個 JSON 套件**（Call #1 / Call #2）。
* A層只是靈感來源；現在的 Schema 已經是**中立、面向任意帳號**，並且是**直接可生成**。
* 你可以在 orchestrator 裡做：

  1. **Call #1** 後立刻做 Schema 驗證 + 覆蓋率檢查（indices 不重疊、總和匹配、比例歸一）。
  2. **Call #2** 前餵入 `business_constraints`（品牌一致性、禁詞、法遵）→ 產生模板時「guardrails」一併納入。
  3. 若驗證失敗：**只回傳錯誤摘要給模型重生**（嚴禁新增敘述，僅修正欄位）。

---

# 最小骨架示例（Call #1 → Call #2 串接）

**Call #1（輸出骨架，值僅示意）**

```json
{
  "analysis_summary": {
    "total_posts": 40,
    "pattern_count": 4,
    "min_samples_per_pattern": 8,
    "merged_rules": "B 與 E 合併為 B（樣本不足）"
  },
  "patterns": [
    {
      "pattern_id": "A",
      "pattern_name": "情感分享_單句型",
      "post_indices": [0,3,5,7,9,12,14,16,20,22],
      "post_count": 10,
      "content_intent": "情感分享",
      "structure_type": "單句型",
      "pragmatics": ["直述","感嘆"],
      "structure_stats": {
        "length_bucket": "短文(≤30字)",
        "sentence_types": {"陳述":70,"疑問":10,"感嘆":20,"祈使":0},
        "paragraphing": "單段",
        "connectors": "句號分隔",
        "symbols": {"emoji_rate":"35%","hashtag_rate":"10%","punctuation_density":"1.6/句"},
        "pace": "急促",
        "cta_strength": "弱"
      },
      "style_markers": {
        "core_vocab": ["超爽","太扯","直接"],
        "tone": "口語、直白、帶情緒起伏",
        "do_nots": ["專業術語過多","嚴肅新聞口吻"]
      },
      "sample_previews": ["今天真的爽！", "太扯了吧…"]
    }
  ]
}
```

**Call #2（輸出骨架，值僅示意）**

```json
{
  "templates": [
    {
      "pattern_id": "A",
      "template_type": "one_liner",
      "length_range": "6-20字",
      "writing_steps": ["丟出情緒核心","加一組具體線索","可選：補一個反差詞"],
      "style_guide": {
        "tone": "直白、情緒高振幅、友善不攻擊",
        "sentence_mix": {"short_ratio":"90%","long_ratio":"10%"},
        "symbols": {"emoji_rate":"30%","hashtag_rate":"10%","punctuation_density":"1.5/句"},
        "cta_rule": "通常不下指令；若下，採軟性邀請"
      },
      "sentence_molds": [
        {"purpose":"開場情緒","pattern":"《情緒詞+感嘆/語助》","example":"爽爆了！"},
        {"purpose":"補具體線索","pattern":"《名詞/事件+微細節》","example":"終於等到更新"},
        {"purpose":"反差收束","pattern":"《轉折詞+簡短對比》","example":"但還是想吐槽…"},
        {"purpose":"軟 CTA","pattern":"《疑問/邀請》","example":"你也遇過嗎？"}
      ],
      "guardrails": {
        "must_include": ["至少1個具體線索或意象"],
        "must_avoid": ["專業術語過多","嚴肅新聞口吻"],
        "consistency_checks": [
          "句長≤20字","emoji_rate 20–40%","不得同篇多個強指令"
        ]
      },
      "variability_knobs": {
        "lexical": "每3-5句一次",
        "syntax": "每8-10句一次",
        "structure": "每6-8篇一次",
        "attention": "每2-3段一次",
        "entropy": {"high":"60%","mid":"25%","low":"12%","unpred":"3%"}
      }
    }
  ],
  "unified_guide": {
    "pattern_selection": [
      {
        "if_context": "速報/強情緒事件",
        "then_use_pattern": "A",
        "because": "單句直述更快完成注意力捕捉"
      }
    ],
    "cross_pattern_techniques": ["單句引爆→短敘事補細節→列點收斂"],
    "optimization_tips": ["控制符號密度避免噪點","CTA 與語氣一致"]
  }
}
```

---

要我直接把這兩份 Schema 包成 `pydantic` 類 + 檢核器（比例和去重驗證、重試策略）丟進你 orchestrator 嗎？我也可以幫你把 System Prompt 兩段化（strict mode / repair mode），確保**兩次調用就穩定拿到可用 JSON**。
