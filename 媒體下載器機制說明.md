# 📥 媒體下載器（RustFS）- 完整機制說明

## 🎯 **核心機制對比**

### 1️⃣ **主要批次下載**（「開始下載」按鈕）
**用途**：批次處理多個帳號的媒體下載
**來源**：從 `playwright_post_metrics` 表的 `images`/`videos` 欄位取得URL
**不會重新爬取**：直接使用資料庫中已有的URL

#### 📊 **設定選項**：

| 選項 | 說明 | 預設值 | 用途 |
|-----|------|--------|------|
| **跳過已完成** | `skip_completed=True` | ✅ 勾選 | 不會重複下載已成功的媒體 |
| **僅未配對** | `only_unpaired=True` | ❌ 未勾選 | 只下載沒有`media_files`記錄的URL |
| **只重試失敗** | `retry_failed_only=True` | ❌ 未勾選 | 只重新下載`download_status='failed'`的項目 |

#### 🔄 **內建自動刷新機制**：
- 如果遇到 **403 Forbidden** 錯誤
- 自動呼叫 `refresh_post_media_urls()` 重新爬取該貼文
- 用新URL重新嘗試下載

---

### 2️⃣ **單篇刷新並下載**（「⬇️ 刷新並下載」按鈕）
**用途**：針對特定貼文強制重新爬取和下載
**強制重新爬取**：一定會用Playwright重新訪問該貼文頁面
**覆蓋舊資料**：新URL會更新到 `playwright_post_metrics` 表

#### 📝 **流程**：
1. 📡 **強制重新爬取**：用Playwright重新訪問貼文頁面
2. 🔄 **更新資料庫**：新的圖片/影片URL覆蓋舊資料
3. ⬇️ **立即下載**：用新URL進行下載
4. 🔄 **自動刷新UI**：下載成功後自動更新統計

---

### 3️⃣ **單篇URL刷新**（「🔄 單篇刷新URL」按鈕）
**用途**：只刷新URL，不下載
**流程**：重新爬取 → 更新資料庫 → 不下載

---

### 4️⃣ **失敗記錄查詢**（「🔍 查看失敗記錄」）
**用途**：查找下載失敗的貼文
**功能**：
- 顯示失敗的貼文URL
- 提供「📋 複製URL」和「🔄 立即重試」按鈕
- 重試使用 `retry_failed_only=True` 機制

---

### 5️⃣ **統計重新整理**（「🔄 重新整理」按鈕）
**用途**：只更新統計資料顯示
**不下載**：純粹重新查詢資料庫並更新表格

---

## 🤔 **使用場景建議**

### 情境1：**新帳號首次下載**
```
選擇：主要批次下載
設定：跳過已完成=✅，僅未配對=❌，只重試失敗=❌
結果：下載所有媒體，已下載的會跳過
```

### 情境2：**只下載失敗的媒體**
```
選擇：主要批次下載  
設定：跳過已完成=✅，僅未配對=❌，只重試失敗=✅
結果：只重新下載失敗的項目
```

### 情境3：**某個貼文一直下載失敗**
```
選擇：單篇刷新並下載
流程：輸入貼文URL → 強制重新爬取 → 下載新URL
適用：URL已過期、頁面結構變化
```

### 情境4：**查看哪些貼文下載失敗**
```
選擇：失敗記錄查詢
功能：列出所有失敗貼文，可單獨重試
```

### 情境5：**影片一直403錯誤**
```
原因：Instagram影片URL有時效性
自動解決：主要批次下載內建自動刷新機制
手動解決：用「單篇刷新並下載」強制更新
```

---

## ⚙️ **技術細節**

### 🔄 **自動刷新觸發條件**：
- 遇到 `403 Forbidden` 錯誤
- 錯誤訊息包含 `"403"` 或 `"Forbidden"`

### 📊 **資料流向**：
```
Playwright爬取 → playwright_post_metrics.images/videos → 下載計畫 → media_files表
```

### 🚨 **重要注意**：
- **主要批次下載**不會主動重新爬取，除非遇到403錯誤
- **單篇刷新並下載**一定會重新爬取，適合解決過期URL問題
- **僅未配對**和**只重試失敗**是互斥的概念
- Instagram影片URL通常6-24小時後過期

---

## 🎛️ **UI操作總結**

| 操作 | 會重新爬取 | 會下載 | 適用情境 |
|------|-----------|--------|----------|
| 開始下載 | ❌ (除非403) | ✅ | 常規批次下載 |
| 刷新並下載 | ✅ | ✅ | URL過期問題 |
| 單篇刷新URL | ✅ | ❌ | 只更新URL |
| 查看失敗記錄 | ❌ | ❌ | 故障排除 |
| 統計重新整理 | ❌ | ❌ | 更新顯示 |
